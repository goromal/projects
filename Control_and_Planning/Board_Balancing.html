<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Board Balancing - Andrew&#x27;s Projects</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex-a3376327.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-f6af6d42.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Andrew&#x27;s Projects</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="board-balancing-technical-project"><a class="header" href="#board-balancing-technical-project">Board Balancing Technical Project</a></h1>
<p>A personal attempt to apply linear control theory to a real-world system.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>I carried out this project in a cabin during Thanksgiving break with my family. I was in the middle of my first official Controls course, and I guess my excitement for the subject prompted me to dedicate some time to mathematical derivations and programming instead of the mountains and the hot tub…</p>
<h2 id="model-description"><a class="header" href="#model-description">Model Description</a></h2>
<p>Basically, the challenge is to have a person balance on top of a board, which in turn is balancing on top of a cylinder (like a two liter bottle or something). I made this physical setup with an old skateboard for fun and to improve my balance in dynamic situations.</p>
<p><strong>Schematic:</strong></p>
<p><img src="../img/BBDiagram.svg" title="Board Balancing Abstraction" alt=""></p>
<p><strong>Assumptions:</strong></p>
<ul>
<li>There is no slip between the ground, the cylinder, and the board.</li>
<li>The finite weight of the person balancing on the board can be shifted between the two feet with negligible rotational inertia effects from the shifting.</li>
<li>Motion confined to the plane.</li>
<li>All objects in the system act as rigid bodies.</li>
</ul>
<p><strong>Equations of Motion and Controller Derivation:</strong></p>
<p>I used the Euler-Lagrange method to model the dynamics of the board balancing system, and decided to try using a state space feedback controller with an integrator to control the system to commanded cylinder rotation angles.</p>
<p>All of my work and the final dynamics/controller equations can be found in <a href="https://andrewtorgesen.github.io/res/Board%20Balancing.pdf">the notes I made over Thanksgiving break</a>. I thought it would be fun to include my hand-written notes to demonstrate both my meandering efforts and the way I like to take notes on all kinds of subjects. There are a lot of colors and pasted images involved, as I prefer to gather information from all around the internet to fill in emergent gaps in my understanding as I go.</p>
<h2 id="matlab-implementation"><a class="header" href="#matlab-implementation">Matlab Implementation</a></h2>
<p><img src="../img/bb_program.svg" title="Block diagram for the board balancing simulation" alt=""></p>
<p>To test out my derived dynamics and controller, I created a simulation in Matlab that models the dynamics of the board balance system and controls it to commanded cylinder angle values. The following sections give code listings for all of the blocks in the above block diagram.</p>
<h3 id="parameters"><a class="header" href="#parameters">Parameters</a></h3>
<p>This code defines all physical parameters for the system, the linearized state space model, the controller parameters, and the signal and animation parameters.</p>
<pre><code class="language-matlab">% Physical Parameters
P.mp = 2;   % mass of plank (kg)
P.mb = 3;   % mass of bottle (kg)
P.g = 9.81; % gravity (m/s^2)
P.dL = 0.25;  % distance from left foot to plank center (m)
P.dR = P.dL;  % distance from right foot to plank center (m)
P.wp = 0.8; % width of plank (m)
P.hp = 0.03;% thickness of board (m)
P.Rb = 0.05; % radius of bottle (m)
P.Ft = 800; % my weight (N)

P.Jb = 1/2*P.mb*P.Rb^2;
P.Jp = 1/12*P.mp*(P.wp^2 + P.hp^2);

% Linearized State-Space Model
P.A = [0 1 0 0;P.Ft*P.Rb/P.Jp 0 P.Ft*P.Rb/P.Jp 0;...
       0 0 0 1;(P.Ft+P.g*P.mp)*P.Rb/P.Jb 0 0 0];
P.B = [0; -(P.dL+P.dR)/P.Jp; 0; 0];
P.C = [0 0 1 0];
n = rank(P.A);

% Full state feedback gains
wnthetab = 40;
wnphi = 10*wnthetab;
zeta = 1/sqrt(2);
desiredPoly = conv([1 2*zeta*wnthetab wnthetab^2],[1 2*zeta*wnphi wnphi^2]);
Ahat = [P.A zeros(n, 1);-P.C 0];
Bhat = [P.B; 0];
K = place(Ahat, Bhat, [roots(desiredPoly); -5]);
P.K = K(1:n);
P.Ki = K(end);

% Saturation limits
buffer = P.Ft;%/2; % the maximum you can go
P.umax = P.Ft/2 + buffer;
P.umin = P.Ft/2 - buffer;

% Animation Parameters
P.footW = .1;   % width of foot (m)
P.footH = .02;  % height of shoe sole (m)
P.floorL = 2;   % length of sim floor (m)
P.ceilH = 0.4;  % height of sim ceiling (m)

% Simulation Parameters
P.phi0 = 0.0;
P.phidot0 = 0.0;
P.thetab0 = 0.0;
P.thetabdot0 = 0.0;

P.t0 = 0.0;
P.tf = 10.0;
P.Ts = 0.0001;
P.t_plot = 100*P.Ts; %0.0001;

P.r_amp = 20*pi/180;
P.r_freq = 1;
</code></pre>
<h3 id="signal-generator"><a class="header" href="#signal-generator">Signal Generator</a></h3>
<p>This code defines functions for generating a signal for the commanded cylinder angle, \(\theta_C\). It defines methods for a square wave, a sawtooth wave, a sine wave, and a random signal.</p>
<pre><code class="language-matlab">classdef signalGenerator
    % produces waves: square, sawtooth, random, sin
    properties
        amplitude
        frequency
        y_offset
    end
    methods
        % constructor ===================================================
        function self = signalGenerator(amplitude, frequency, y_offset)
            self.amplitude = amplitude;
            if nargin &gt; 1
                self.frequency = frequency;
            else
                self.frequency = 1;
            end
            if nargin &gt; 2
                self.y_offset = y_offset;
            else
                self.y_offset = 0;
            end
        end
        % signal outputs ================================================
        function out = square(self, t)
            % if in first half of period, output positive, else negative
            if mod(t, 1/self.frequency) &lt;= 0.5/self.frequency
                out = self.amplitude + self.y_offset;
            else
                out = -self.amplitude + self.y_offset;
            end
        end
        function out = sawtooth(self, t)
            out = 4*self.amplitude*self.frequency * mod(t, 0.5/self.frequency)...
                - self.amplitude + self.y_offset;
        end
        function out = random(self, t)
            out = sqrt(self.amplitude)*randn + self.y_offset;
        end
        function out = sin(self, t)
            out = self.amplitude*sin(2*pi*self.frequency*t) + self.y_offset;
        end
    end
end
</code></pre>
<h3 id="data-plotter"><a class="header" href="#data-plotter">Data Plotter</a></h3>
<p>This code creates plots that update in real time with important information about the performance of the system.</p>
<pre><code class="language-matlab">classdef plotData &lt; handle
    properties
        % data histories
        time_history
        thetab_history
        thetab_r_history
        F_history
        index
        % figure handles
        thetab_r_handle
        thetab_handle
        F_handle
    end
    methods
        %--constructor--------------------------
        function self = plotData(P)
            % Instantiate lists to hold the time and data histories
            n = ceil((P.tf-P.t0)/P.t_plot);
            self.time_history = NaN*ones(1,n);
            self.thetab_history = NaN*ones(1,n);
            self.thetab_r_history = NaN*ones(1,n);
            self.F_history = NaN*ones(1,n);
            self.index = 1;

            % Create figure and axes handles
            figure(2), clf
            subplot(2, 1, 1)
                hold on
                self.thetab_r_handle = plot(self.time_history, self.thetab_r_history, 'r');
                self.thetab_handle = plot(self.time_history, self.thetab_history, 'k');
                ylabel('theta (degrees)')
                title('Output Comparison')
            subplot(2, 1, 2)
                hold on
                self.F_handle = plot(self.time_history, self.F_history, 'k');
                ylabel('F (N)')
                xlabel('t (s)')
                title('Right Foot Force')
        end
        %----------------------------
        function self = updatePlots(self, t, thetab_r, thetab, F)
            % update the time history of all plot variables
            self.time_history(self.index) = t;
            self.thetab_r_history(self.index) = thetab_r;
            self.thetab_history(self.index) = thetab;
            self.F_history(self.index) = F;
            self.index = self.index + 1;

            % update the plots with associated histories
            set(self.thetab_r_handle, 'Xdata', self.time_history, 'Ydata', self.thetab_r_history)
            set(self.thetab_handle, 'Xdata', self.time_history, 'Ydata', self.thetab_history)
            set(self.F_handle, 'Xdata', self.time_history, 'Ydata', self.F_history)
        end
    end
end
</code></pre>
<h3 id="animation"><a class="header" href="#animation">Animation</a></h3>
<p>This code draws the board balancing system, dynamically updating the drawing to create an animation based on the current state in the simulation.</p>
<pre><code class="language-matlab">classdef animation
    properties
        plank_handle
        left_foot_handle
        right_foot_handle
        bottle_handle
        floorL
        ceilH
        footW
        footH
        dL
        dR
        wp
        hp
        Rb
    end
    methods
        % constructor ===================================================
        function self = animation(P)
            self.floorL = P.floorL;
            self.ceilH = P.ceilH;
            self.footW = P.footW;
            self.footH = P.footH;
            self.dL = P.dL;
            self.dR = P.dR;
            self.wp = P.wp;
            self.hp = P.hp;
            self.Rb = P.Rb;

            figure(1), clf

            % draw wall and floor
            plot([-self.floorL/2, -self.floorL/2, self.floorL/2],[self.ceilH, 0, 0],'k--');
            hold on

            % initialize mass, spring, and damper
            self = self.drawPlank(P.phi0, P.thetab0);
            self = self.drawLeftFoot(P.phi0, P.thetab0);
            self = self.drawRightFoot(P.phi0, P.thetab0);
            self = self.drawBottle(P.thetab0);

            % change axis limits
            axis([-self.floorL/2, self.floorL/2, -0.1, self.ceilH]);
            pbaspect([self.floorL, self.ceilH+.1, 1]);
        end
        % drawing methods ===============================================
        function self = drawSystem(self, substate)
            phi = substate(1);
            thetab = substate(2);
            self = self.drawPlank(phi, thetab);
            self = self.drawLeftFoot(phi, thetab);
            self = self.drawRightFoot(phi, thetab);
            self = self.drawBottle(thetab);
            drawnow
        end
        function self = drawPlank(self, phi, thetab)
            % untransformed coordinates, row vector of (x,y) coords
            X = [-self.wp/2, self.wp/2,  self.wp/2, -self.wp/2, -self.wp/2;...
                  self.hp/2, self.hp/2, -self.hp/2, -self.hp/2,  self.hp/2];
            % rotate by phi
            R = [cos(phi) -sin(phi);sin(phi) cos(phi)];
            X = R*X;
            % translate
            X = X + self.Rb*[-thetab-(sin(phi)+thetab*cos(phi));1+cos(phi)-thetab*sin(phi)]...
                + [0;self.hp/2];
            % draw
            if isempty(self.plank_handle)
                self.plank_handle = plot(X(1,:), X(2,:), 'k');
            else
                set(self.plank_handle, 'XData', X(1,:), 'YData', X(2,:));
            end
        end
        function self = drawLeftFoot(self, phi, thetab)
            % untransformed coordinates, row vector of (x,y) coords
            X = [-self.footW/2, self.footW/2,  self.footW/2, -self.footW/2, -self.footW/2;...
                  self.footH/2, self.footH/2, -self.footH/2, -self.footH/2,  self.footH/2];
            % translate
            X = X + self.Rb*[-thetab-(sin(phi)+thetab*cos(phi));1+cos(phi)-thetab*sin(phi)]...
                + [-self.dL;self.hp + self.footH/2];

            % rotate by phi
            R = [cos(phi) -sin(phi);sin(phi) cos(phi)];
            X = R*X;

            % draw
            if isempty(self.left_foot_handle)
                self.left_foot_handle = plot(X(1,:), X(2,:), 'r');
            else
                set(self.left_foot_handle, 'XData', X(1,:), 'YData', X(2,:));
            end
        end
        function self = drawRightFoot(self, phi, thetab)
            % untransformed coordinates, row vector of (x,y) coords
            X = [-self.footW/2, self.footW/2,  self.footW/2, -self.footW/2, -self.footW/2;...
                  self.footH/2, self.footH/2, -self.footH/2, -self.footH/2,  self.footH/2];
            % translate
            X = X + self.Rb*[-thetab-(sin(phi)+thetab*cos(phi));1+cos(phi)-thetab*sin(phi)]...
                + [self.dR;self.hp + self.footH/2];

            % rotate by phi
            R = [cos(phi) -sin(phi);sin(phi) cos(phi)];
            X = R*X;
            % draw
            if isempty(self.right_foot_handle)
                self.right_foot_handle = plot(X(1,:), X(2,:), 'r');
            else
                set(self.right_foot_handle, 'XData', X(1,:), 'YData', X(2,:));
            end
        end
        function self = drawBottle(self, thetab)
            th = 0:pi/50:2*pi;
            X = self.Rb*cos(th) - self.Rb*thetab;
            Y = self.Rb*sin(th) + self.Rb;

            if isempty(self.bottle_handle)
                self.bottle_handle = plot(X, Y, 'b');
            else
                set(self.bottle_handle, 'XData', X, 'YData', Y);
            end
        end
    end
end
</code></pre>
<h3 id="dynamics"><a class="header" href="#dynamics">Dynamics</a></h3>
<p>This code defines the nonlinear, coupled differential equations which describe the evolution of the board balancing system given an input, which is the distribution of shifted weight of the human “pilot” between the two feet.</p>
<pre><code class="language-matlab">classdef dynamics &lt; handle
    %  Model the physical system
    %----------------------------
    properties
        state
        mp
        mb
        g
        dL
        dR
        Rb
        Ft
        Jb
        Jp
        Cmat
        Ts
    end
    %----------------------------
    methods
        %---constructor-------------------------
        function self = dynamics(P)
            % Initial state conditions
            self.state = [...
                        P.phi0;...                
                        P.phidot0;...
                        P.thetab0;...
                        P.thetabdot0
                        ];     
            self.mp = P.mp;
            self.mb = P.mb;
            self.g = P.g;
            self.dL = P.dL;
            self.dR = P.dR;
            self.Rb = P.Rb;
            self.Ft = P.Ft;
            self.Jb = P.Jb;
            self.Jp = P.Jp;
            self.Cmat = P.C;
            self.Ts = P.Ts;
        end
        %----------------------------
        function self = propagateDynamics(self, u)
            % Integrate ODE using Runge-Kutta RK4 algorithm
            k1 = self.derivatives(self.state, u);
            k2 = self.derivatives(self.state + self.Ts/2*k1, u);
            k3 = self.derivatives(self.state + self.Ts/2*k2, u);
            k4 = self.derivatives(self.state + self.Ts*k3, u);
            self.state = self.state + self.Ts/6 * (k1 + 2*k2 + 2*k3 + k4);
        end
        %----------------------------
        function xdot = derivatives(self, state, u)
            Fr = u;
            phi = state(1);
            phidot = state(2);
            thetab = state(3);
            thetabdot = state(4);
            phiddot = (self.Ft-Fr)/self.Jp*(self.dL + self.Rb*(sin(phi)+thetab*cos(phi)))...
                - Fr/self.Jp*(self.dR - self.Rb*(sin(phi)+thetab*cos(phi)));
            thetabddot = self.Rb/self.Jb*(self.Ft + self.mp*self.g)*sin(phi);
            xdot = [phidot; phiddot; thetabdot; thetabddot];
        end
        %----------------------------
        function y = getOutput(self)
            y = self.Cmat * self.state;
        end
        %----------------------------
        function xs = getSubState(self)
            phi = self.state(1);
            thetab = self.state(3);
            xs = [phi; thetab];
        end
        %----------------------------
        function x = getState(self)
            x = self.state;
        end
    end
end
</code></pre>
<h3 id="controller"><a class="header" href="#controller">Controller</a></h3>
<p>This code implements a full-state feedback controller with an integrator:</p>
<p>$$ F = F_e - Kx - k_i\zeta_e $$</p>
<p>as well as input saturation and integrator anti-windup. The integrator term allows for the full-state feedback system to act as a controller instead of just a regulator, accepting non-zero values for \(\theta_C\).</p>
<pre><code class="language-matlab">classdef controller &lt; handle
    %  Implements full-state feedback control without an integrator or
    %  saturation
    %----------------------------
    properties
        param
        zeta_e
        error_km1
    end
    %----------------------------
    methods
        %----------------------------
        function self = controller(P)
            self.param = P;
            self.zeta_e = 0;
            self.error_km1 = 0;
        end
        %----------------------------
        function F = u(self, y_r, x)
            % Calculate equilibrium force due to linearization
            Fe = self.param.Ft*(self.param.dL + self.param.Rb*x(3))/(self.param.dR+self.param.dL);
            % Integrate the error to update zeta_e
            self.integrateError(y_r - self.param.C*x);
            % Calculate the unsaturated force using state
            F_unsat = Fe - self.param.K*x - self.param.Ki*self.zeta_e;
            % Saturate input
            F = self.sat(F_unsat);
            % Implement anti-windup
            if self.param.Ki ~= 0
                self.zeta_e = self.zeta_e + 1/self.param.Ki*(F - F_unsat);
            end
        end
        %----------------------------
        function F_sat = sat(self, u)
            F_sat = u;
            if u &gt; self.param.umax
                F_sat = self.param.umax;
            elseif u &lt; self.param.umin
                F_sat = self.param.umin;
            end
        end
        %----------------------------
        function self = integrateError(self, error)
            self.zeta_e = self.zeta_e + self.param.Ts/2*...
                (error + self.error_km1);
            self.error_km1 = error;
        end
    end
end
</code></pre>
<h3 id="simulator"><a class="header" href="#simulator">Simulator</a></h3>
<p>This code puts everything together in a simulation loop.</p>
<pre><code class="language-matlab">param;

SYS = dynamics(P);
CNTRL = controller(P);
ANMTN = animation(P);

thetabRef1 = signalGenerator(pi, 0.5);
thetabRef2 = signalGenerator(pi/4, 0.25);

dataPlot = plotData(P);

% main simulation loop
t = P.t0;
while t &lt; P.tf  
    r = thetabRef1.square(t) + thetabRef2.square(t);
    t_next_plot = t + P.t_plot;
    while t &lt; t_next_plot
        u = CNTRL.u(r, SYS.getState());
        SYS.propagateDynamics(u);
        t = t + P.Ts;
    end
    dataPlot.updatePlots(t, r, SYS.getOutput(), u);
    ANMTN.drawSystem(SYS.getSubState());
    pause(P.t_plot)
end
</code></pre>
<h2 id="simulation-results"><a class="header" href="#simulation-results">Simulation Results</a></h2>
<p>The animation and plots below demonstrate the ability of the feedback controller to track step commands without overshoot and with a rise time of \(\approx 0.5\) seconds.</p>
<p><img src="../img/bbSim.gif" title="Board balancing full-state feedback performance" alt=""></p>
<p>Surely, there is a lot more that could have been done with this setup, from model validation to implementing disturbances and more advanced control techniques–perhaps even nonlinear control. That being said, this was primarily a fun exercise and an opportunity to apply the principles of my first controls course from the ground-up.</p>
<p>This project is a good example of the type of work that I most enjoy, which entails full-fledged analysis of a system and writing algorithms to leverage that understanding to make things happen. Math, engineering, and programming knowledge are all required in such projects, which is probably why I find them to be so stimulating.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Control_and_Planning/Apollo_Spacecraft_Control.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../Control_and_Planning/Genetic_Algorithm-Based_UAV_Path_Planner.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Control_and_Planning/Apollo_Spacecraft_Control.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../Control_and_Planning/Genetic_Algorithm-Based_UAV_Path_Planner.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
